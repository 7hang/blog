é—®é¢˜



### 1. ä¸€ä¸ªobjcå¯¹è±¡å¦‚ä½•è¿›è¡Œå†…å­˜å¸ƒå±€ï¼Ÿï¼ˆè€ƒè™‘æœ‰çˆ¶ç±»çš„æƒ…å†µï¼‰

 - æ‰€æœ‰çˆ¶ç±»çš„æˆå‘˜å˜é‡å’Œè‡ªå·±çš„æˆå‘˜å˜é‡éƒ½ä¼šå­˜æ”¾åœ¨è¯¥å¯¹è±¡æ‰€å¯¹åº”çš„å­˜å‚¨ç©ºé—´ä¸­.
 - æ¯ä¸€ä¸ªå¯¹è±¡å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªisaæŒ‡é’ˆ,æŒ‡å‘ä»–çš„ç±»å¯¹è±¡,ç±»å¯¹è±¡ä¸­å­˜æ”¾ç€æœ¬å¯¹è±¡çš„



    1. å¯¹è±¡æ–¹æ³•åˆ—è¡¨ï¼ˆå¯¹è±¡èƒ½å¤Ÿæ¥æ”¶çš„æ¶ˆæ¯åˆ—è¡¨ï¼Œä¿å­˜åœ¨å®ƒæ‰€å¯¹åº”çš„ç±»å¯¹è±¡ä¸­ï¼‰
    2. æˆå‘˜å˜é‡çš„åˆ—è¡¨,
    3. å±æ€§åˆ—è¡¨,

 å®ƒå†…éƒ¨ä¹Ÿæœ‰ä¸€ä¸ªisaæŒ‡é’ˆæŒ‡å‘å…ƒå¯¹è±¡(meta class),å…ƒå¯¹è±¡å†…éƒ¨å­˜æ”¾çš„æ˜¯ç±»æ–¹æ³•åˆ—è¡¨,ç±»å¯¹è±¡å†…éƒ¨è¿˜æœ‰ä¸€ä¸ªsuperclassçš„æŒ‡é’ˆ,æŒ‡å‘ä»–çš„çˆ¶ç±»å¯¹è±¡ã€‚

æ¯ä¸ª Objective-C å¯¹è±¡éƒ½æœ‰ç›¸åŒçš„ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

 ![https://github.com/ChenYilong](http://i.imgur.com/7mJlUj1.png)

ç¿»è¯‘è¿‡æ¥å°±æ˜¯

|                          | Objective-C å¯¹è±¡çš„ç»“æ„å›¾ |      |
| ------------------------ | ------------------------ | ---- |
| ISAæŒ‡é’ˆ                  |                          |      |
| æ ¹ç±»çš„å®ä¾‹å˜é‡           |                          |      |
| å€’æ•°ç¬¬äºŒå±‚çˆ¶ç±»çš„å®ä¾‹å˜é‡ |                          |      |
| ...                      |                          |      |
| çˆ¶ç±»çš„å®ä¾‹å˜é‡           |                          |      |
| ç±»çš„å®ä¾‹å˜é‡             |                          |      |


 - æ ¹å¯¹è±¡å°±æ˜¯NSObjectï¼Œå®ƒçš„superclassæŒ‡é’ˆæŒ‡å‘nil

 - ç±»å¯¹è±¡æ—¢ç„¶ç§°ä¸ºå¯¹è±¡ï¼Œé‚£å®ƒä¹Ÿæ˜¯ä¸€ä¸ªå®ä¾‹ã€‚ç±»å¯¹è±¡ä¸­ä¹Ÿæœ‰ä¸€ä¸ªisaæŒ‡é’ˆæŒ‡å‘å®ƒçš„å…ƒç±»(meta class)ï¼Œå³ç±»å¯¹è±¡æ˜¯å…ƒç±»çš„å®ä¾‹ã€‚å…ƒç±»å†…éƒ¨å­˜æ”¾çš„æ˜¯ç±»æ–¹æ³•åˆ—è¡¨ï¼Œæ ¹å…ƒç±»çš„isaæŒ‡é’ˆæŒ‡å‘è‡ªå·±ï¼ŒsuperclassæŒ‡é’ˆæŒ‡å‘NSObjectç±»ã€‚
 - ç±»å¯¹è±¡ æ˜¯æ”¾åœ¨æ•°æ®æ®µ(æ•°æ®åŒº)ä¸Šçš„, å’Œå…¨å±€å˜é‡æ”¾åœ¨ä¸€ä¸ªåœ°æ–¹. è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ: åŒä¸€ä¸ªç±»å¯¹è±¡çš„ä¸åŒå®ä¾‹å¯¹è±¡,çš„isaæŒ‡é’ˆæ˜¯ä¸€æ ·çš„.
 - å®ä¾‹å¯¹è±¡å­˜æ”¾åœ¨å †ä¸­



å¦‚å›¾:
![https://github.com/ChenYilong](http://i.imgur.com/w6tzFxz.png)



### 2. ä¸‹é¢çš„ä»£ç è¾“å‡ºä»€ä¹ˆï¼Ÿ




 ```Objective-C
	@implementation Son : Father
	- (id)init
	{
	    self = [super init];
	    if (self) {
	        NSLog(@"%@", NSStringFromClass([self class]));
	        NSLog(@"%@", NSStringFromClass([super class]));
	    }
	    return self;
	}
	@end
 ```


**ç­”æ¡ˆï¼š**

éƒ½è¾“å‡º Son

	NSStringFromClass([self class]) = Son
	NSStringFromClass([super class]) = Son



è¿™ä¸ªé¢˜ç›®ä¸»è¦æ˜¯è€ƒå¯Ÿå…³äº Objective-C ä¸­å¯¹ self å’Œ super çš„ç†è§£ã€‚

superå…³é”®å­—ï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š

- receiverè¿˜æ˜¯å½“å‰ç±»å¯¹è±¡ï¼Œè€Œä¸æ˜¯çˆ¶ç±»å¯¹è±¡ï¼›
- superè¿™é‡Œçš„å«ä¹‰å°±æ˜¯ä¼˜å…ˆå»çˆ¶ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­å»æŸ¥å®ç°ï¼Œå¾ˆå¤šé—®é¢˜éƒ½æ˜¯çˆ¶ç±»ä¸­å…¶å®ä¹Ÿæ²¡æœ‰å®ç°ï¼Œè¿˜æ˜¯å»æ ¹ç±»é‡Œ å»æ‰¾å®ç°ï¼Œè¿™ç§æƒ…å†µä¸‹æ—¶ï¼Œå…¶å®è·Ÿç›´æ¥è°ƒç”¨selfçš„æ•ˆæœæ˜¯ä¸€è‡´çš„ã€‚

ä¸‹é¢åšè¯¦ç»†ä»‹ç»:

æˆ‘ä»¬éƒ½çŸ¥é“ï¼šself æ˜¯ç±»çš„éšè—å‚æ•°ï¼ŒæŒ‡å‘å½“å‰è°ƒç”¨æ–¹æ³•çš„è¿™ä¸ªç±»çš„å®ä¾‹ã€‚é‚£ super å‘¢ï¼Ÿ

å¾ˆå¤šäººä¼šæƒ³å½“ç„¶çš„è®¤ä¸ºâ€œ super å’Œ self ç±»ä¼¼ï¼Œåº”è¯¥æ˜¯æŒ‡å‘çˆ¶ç±»çš„æŒ‡é’ˆå§ï¼â€ã€‚è¿™æ˜¯å¾ˆæ™®éçš„ä¸€ä¸ªè¯¯åŒºã€‚å…¶å® super æ˜¯ä¸€ä¸ª Magic Keywordï¼Œ å®ƒæœ¬è´¨æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨æ ‡ç¤ºç¬¦ï¼Œå’Œ self æ˜¯æŒ‡å‘çš„åŒä¸€ä¸ªæ¶ˆæ¯æ¥å—è€…ï¼ä»–ä»¬ä¸¤ä¸ªçš„ä¸åŒç‚¹åœ¨äºï¼šsuper ä¼šå‘Šè¯‰ç¼–è¯‘å™¨ï¼Œè°ƒç”¨ class è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œè¦å»çˆ¶ç±»çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯æœ¬ç±»é‡Œçš„ã€‚


ä¸Šé¢çš„ä¾‹å­ä¸ç®¡è°ƒç”¨`[self class]`è¿˜æ˜¯`[super class]`ï¼Œæ¥å—æ¶ˆæ¯çš„å¯¹è±¡éƒ½æ˜¯å½“å‰ `Son ï¼Šxxx` è¿™ä¸ªå¯¹è±¡ã€‚

å½“ä½¿ç”¨ self è°ƒç”¨æ–¹æ³•æ—¶ï¼Œä¼šä»å½“å‰ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­å¼€å§‹æ‰¾ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä»çˆ¶ç±»ä¸­å†æ‰¾ï¼›è€Œå½“ä½¿ç”¨ super æ—¶ï¼Œåˆ™ä»çˆ¶ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­å¼€å§‹æ‰¾ã€‚ç„¶åè°ƒç”¨çˆ¶ç±»çš„è¿™ä¸ªæ–¹æ³•ã€‚


è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¯´â€œä¸æ¨èåœ¨ init æ–¹æ³•ä¸­ä½¿ç”¨ç‚¹è¯­æ³•â€ï¼Œå¦‚æœæƒ³è®¿é—®å®ä¾‹å˜é‡ iVar åº”è¯¥ä½¿ç”¨ä¸‹åˆ’çº¿ï¼ˆ `_iVar` ï¼‰ï¼Œè€Œéç‚¹è¯­æ³•ï¼ˆ `self.iVar` ï¼‰ã€‚

ç‚¹è¯­æ³•ï¼ˆ `self.iVar` ï¼‰çš„åå¤„å°±æ˜¯å­ç±»æœ‰å¯èƒ½è¦†å†™ setter ã€‚å‡è®¾ Person æœ‰ä¸€ä¸ªå­ç±»å« ChenPersonï¼Œè¿™ä¸ªå­ç±»ä¸“é—¨è¡¨ç¤ºé‚£äº›å§“â€œé™ˆâ€çš„äººã€‚è¯¥å­ç±»å¯èƒ½ä¼šè¦†å†™ lastName å±æ€§æ‰€å¯¹åº”çš„è®¾ç½®æ–¹æ³•ï¼š

 ```Objective-C
//
//  ChenPerson.m
//  
//
//  Created by https://github.com/ChenYilong on 15/8/30.
//  Copyright (c) 2015å¹´ http://weibo.com/luohanchenyilong/ å¾®åš@iOSç¨‹åºçŠ­è¢. All rights reserved.
//

#import "ChenPerson.h"

@implementation ChenPerson

@synthesize lastName = _lastName;

- (instancetype)init
{
    self = [super init];
    if (self) {
        NSLog(@"ğŸ”´ç±»åä¸æ–¹æ³•åï¼š%sï¼ˆåœ¨ç¬¬%dè¡Œï¼‰ï¼Œæè¿°ï¼š%@", __PRETTY_FUNCTION__, __LINE__, NSStringFromClass([self class]));
        NSLog(@"ğŸ”´ç±»åä¸æ–¹æ³•åï¼š%sï¼ˆåœ¨ç¬¬%dè¡Œï¼‰ï¼Œæè¿°ï¼š%@", __PRETTY_FUNCTION__, __LINE__, NSStringFromClass([super class]));
    }
    return self;
}

- (void)setLastName:(NSString*)lastName
{
    //è®¾ç½®æ–¹æ³•ä¸€ï¼šå¦‚æœsetteré‡‡ç”¨æ˜¯è¿™ç§æ–¹å¼ï¼Œå°±å¯èƒ½å¼•èµ·å´©æºƒ
//    if (![lastName isEqualToString:@"é™ˆ"])
//    {
//        [NSException raise:NSInvalidArgumentException format:@"å§“ä¸æ˜¯é™ˆ"];
//    }
//    _lastName = lastName;
    
    //è®¾ç½®æ–¹æ³•äºŒï¼šå¦‚æœsetteré‡‡ç”¨æ˜¯è¿™ç§æ–¹å¼ï¼Œå°±å¯èƒ½å¼•èµ·å´©æºƒ
    _lastName = @"é™ˆ";
    NSLog(@"ğŸ”´ç±»åä¸æ–¹æ³•åï¼š%sï¼ˆåœ¨ç¬¬%dè¡Œï¼‰ï¼Œæè¿°ï¼š%@", __PRETTY_FUNCTION__, __LINE__, @"ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•,æƒ³ä¸€ä¸‹ä¸ºä»€ä¹ˆï¼Ÿ");

}

@end
 ```

åœ¨åŸºç±» Person çš„é»˜è®¤åˆå§‹åŒ–æ–¹æ³•ä¸­ï¼Œå¯èƒ½ä¼šå°†å§“æ°è®¾ä¸ºç©ºå­—ç¬¦ä¸²ã€‚æ­¤æ—¶è‹¥ä½¿ç”¨ç‚¹è¯­æ³•ï¼ˆ `self.lastName` ï¼‰ä¹Ÿå³ setter è®¾ç½®æ–¹æ³•ï¼Œé‚£ä¹ˆè°ƒç”¨å°†ä¼šæ˜¯å­ç±»çš„è®¾ç½®æ–¹æ³•ï¼Œå¦‚æœåœ¨åˆšåˆšçš„ setter ä»£ç ä¸­é‡‡ç”¨è®¾ç½®æ–¹æ³•ä¸€ï¼Œé‚£ä¹ˆå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œ


ä¸ºäº†æ–¹ä¾¿é‡‡ç”¨æ‰“å°çš„æ–¹å¼å±•ç¤ºï¼Œç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼Œæˆ‘ä»¬ä½¿ç”¨è®¾ç½®æ–¹æ³•äºŒã€‚


å¦‚æœåŸºç±»çš„ä»£ç æ˜¯è¿™æ ·çš„ï¼š


 ```Objective-C
//
//  Person.m
//  nilå¯¹è±¡è°ƒç”¨ç‚¹è¯­æ³•
//
//  Created by https://github.com/ChenYilong on 15/8/29.
//  Copyright (c) 2015å¹´ http://weibo.com/luohanchenyilong/ å¾®åš@iOSç¨‹åºçŠ­è¢. All rights reserved.
//  

#import "Person.h"

@implementation Person

- (instancetype)init
{
    self = [super init];
    if (self) {
        self.lastName = @"";
        //NSLog(@"ğŸ”´ç±»åä¸æ–¹æ³•åï¼š%sï¼ˆåœ¨ç¬¬%dè¡Œï¼‰ï¼Œæè¿°ï¼š%@", __PRETTY_FUNCTION__, __LINE__, NSStringFromClass([self class]));
        //NSLog(@"ğŸ”´ç±»åä¸æ–¹æ³•åï¼š%sï¼ˆåœ¨ç¬¬%dè¡Œï¼‰ï¼Œæè¿°ï¼š%@", __PRETTY_FUNCTION__, __LINE__, self.lastName);
    }
    return self;
}

- (void)setLastName:(NSString*)lastName
{
    NSLog(@"ğŸ”´ç±»åä¸æ–¹æ³•åï¼š%sï¼ˆåœ¨ç¬¬%dè¡Œï¼‰ï¼Œæè¿°ï¼š%@", __PRETTY_FUNCTION__, __LINE__, @"æ ¹æœ¬ä¸ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•");
    _lastName = @"ç‚é»„";
}

@end
 ```

é‚£ä¹ˆæ‰“å°ç»“æœå°†ä¼šæ˜¯è¿™æ ·çš„ï¼š

 ```Objective-C
 ğŸ”´ç±»åä¸æ–¹æ³•åï¼š-[ChenPerson setLastName:]ï¼ˆåœ¨ç¬¬36è¡Œï¼‰ï¼Œæè¿°ï¼šä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•,æƒ³ä¸€ä¸‹ä¸ºä»€ä¹ˆï¼Ÿ
 ğŸ”´ç±»åä¸æ–¹æ³•åï¼š-[ChenPerson init]ï¼ˆåœ¨ç¬¬19è¡Œï¼‰ï¼Œæè¿°ï¼šChenPerson
 ğŸ”´ç±»åä¸æ–¹æ³•åï¼š-[ChenPerson init]ï¼ˆåœ¨ç¬¬20è¡Œï¼‰ï¼Œæè¿°ï¼šChenPerson
 ```

æˆ‘åœ¨ä»“åº“é‡Œä¹Ÿç»™å‡ºäº†ä¸€ä¸ªç›¸åº”çš„ Demoï¼ˆåå­—å«ï¼šDemo_21é¢˜_ä¸‹é¢çš„ä»£ç è¾“å‡ºä»€ä¹ˆï¼‰ã€‚æœ‰å…´è¶£å¯ä»¥è·‘èµ·æ¥çœ‹ä¸€ä¸‹ï¼Œä¸»è¦çœ‹ä¸‹ä»–æ˜¯æ€ä¹ˆæ‰“å°çš„ï¼Œæ€è€ƒä¸‹ä¸ºä»€ä¹ˆè¿™ä¹ˆæ‰“å°ã€‚

å¦‚æœå¯¹è¿™ä¸ªä¾‹å­æœ‰ç–‘é—®ï¼šå¯ä»¥å‚ä¸è®¨è®ºåŒºè®¨è®º [ã€Š21é¢˜â€œä¸æ¨èåœ¨ init æ–¹æ³•ä¸­ä½¿ç”¨ç‚¹è¯­æ³•â€ #75ã€‹]( https://github.com/ChenYilong/iOSInterviewQuestions/issues/75 ) 

æ¥ä¸‹æ¥è®©æˆ‘ä»¬åˆ©ç”¨ runtime çš„ç›¸å…³çŸ¥è¯†æ¥éªŒè¯ä¸€ä¸‹ super å…³é”®å­—çš„æœ¬è´¨ï¼Œä½¿ç”¨clangé‡å†™å‘½ä»¤:


 ```Objective-C
	$ clang -rewrite-objc test.m
 ```

å°†è¿™é“é¢˜ç›®ä¸­ç»™å‡ºçš„ä»£ç è¢«è½¬åŒ–ä¸º:


 ```Objective-C
    NSLog((NSString *)&__NSConstantStringImpl__var_folders_gm_0jk35cwn1d3326x0061qym280000gn_T_main_a5cecc_mi_0, NSStringFromClass(((Class (*)(id, SEL))(void *)objc_msgSend)((id)self, sel_registerName("class"))));

    NSLog((NSString *)&__NSConstantStringImpl__var_folders_gm_0jk35cwn1d3326x0061qym280000gn_T_main_a5cecc_mi_1, NSStringFromClass(((Class (*)(__rw_objc_super *, SEL))(void *)objc_msgSendSuper)((__rw_objc_super){ (id)self, (id)class_getSuperclass(objc_getClass("Son")) }, sel_registerName("class"))));
 ```

ä»ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°åœ¨è°ƒç”¨ [self class] æ—¶ï¼Œä¼šè½¬åŒ–æˆ `objc_msgSend`å‡½æ•°ã€‚çœ‹ä¸‹å‡½æ•°å®šä¹‰ï¼š


 ```Objective-C
	id objc_msgSend(id self, SEL op, ...)
 ```

æˆ‘ä»¬æŠŠ self åšä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’è¿›å»ã€‚

è€Œåœ¨è°ƒç”¨ [super class]æ—¶ï¼Œä¼šè½¬åŒ–æˆ `objc_msgSendSuper`å‡½æ•°ã€‚çœ‹ä¸‹å‡½æ•°å®šä¹‰:


 ```Objective-C
	id objc_msgSendSuper(struct objc_super *super, SEL op, ...)
 ```

ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ `objc_super` è¿™æ ·ä¸€ä¸ªç»“æ„ä½“ï¼Œå…¶å®šä¹‰å¦‚ä¸‹:


 ```Objective-C
struct objc_super {
	   __unsafe_unretained id receiver;
	   __unsafe_unretained Class super_class;
};
 ```

ç»“æ„ä½“æœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯ receiver, ç±»ä¼¼äºä¸Šé¢çš„ `objc_msgSend`å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°self ã€‚ç¬¬äºŒä¸ªæˆå‘˜æ˜¯è®°å½•å½“å‰ç±»çš„çˆ¶ç±»æ˜¯ä»€ä¹ˆã€‚

æ‰€ä»¥ï¼Œå½“è°ƒç”¨ ï¼»self class] æ—¶ï¼Œå®é™…å…ˆè°ƒç”¨çš„æ˜¯ `objc_msgSend`å‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ Sonå½“å‰çš„è¿™ä¸ªå®ä¾‹ï¼Œç„¶ååœ¨ Son è¿™ä¸ªç±»é‡Œé¢å»æ‰¾ - (Class)classè¿™ä¸ªæ–¹æ³•ï¼Œæ²¡æœ‰ï¼Œå»çˆ¶ç±» Fatheré‡Œæ‰¾ï¼Œä¹Ÿæ²¡æœ‰ï¼Œæœ€ååœ¨ NSObjectç±»ä¸­å‘ç°è¿™ä¸ªæ–¹æ³•ã€‚è€Œ - (Class)classçš„å®ç°å°±æ˜¯è¿”å›selfçš„ç±»åˆ«ï¼Œæ•…ä¸Šè¿°è¾“å‡ºç»“æœä¸º Sonã€‚

objc Runtimeå¼€æºä»£ç å¯¹- (Class)classæ–¹æ³•çš„å®ç°:


 ```Objective-C
- (Class)class {
    return object_getClass(self);
}
 ```

è€Œå½“è°ƒç”¨ `[super class]`æ—¶ï¼Œä¼šè½¬æ¢æˆ`objc_msgSendSuperå‡½æ•°`ã€‚ç¬¬ä¸€æ­¥å…ˆæ„é€  `objc_super` ç»“æ„ä½“ï¼Œç»“æ„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜å°±æ˜¯ `self` ã€‚
ç¬¬äºŒä¸ªæˆå‘˜æ˜¯ `(id)class_getSuperclass(objc_getClass(â€œSonâ€))` , å®é™…è¯¥å‡½æ•°è¾“å‡ºç»“æœä¸º Fatherã€‚

ç¬¬äºŒæ­¥æ˜¯å» Fatherè¿™ä¸ªç±»é‡Œå»æ‰¾ `- (Class)class`ï¼Œæ²¡æœ‰ï¼Œç„¶åå»NSObjectç±»å»æ‰¾ï¼Œæ‰¾åˆ°äº†ã€‚æœ€åå†…éƒ¨æ˜¯ä½¿ç”¨ `objc_msgSend(objc_super->receiver, @selector(class))`å»è°ƒç”¨ï¼Œ

æ­¤æ—¶å·²ç»å’Œ`[self class]`è°ƒç”¨ç›¸åŒäº†ï¼Œæ•…ä¸Šè¿°è¾“å‡ºç»“æœä»ç„¶è¿”å› Sonã€‚


å‚è€ƒé“¾æ¥ï¼š[å¾®åš@Chun_iOS](http://weibo.com/junbbcom)çš„åšæ–‡[åˆ¨æ ¹é—®åº•Objectiveï¼C Runtimeï¼ˆ1ï¼‰ï¼ Self & Super](http://chun.tips/blog/2014/11/05/bao-gen-wen-di-objective%5Bnil%5Dc-runtime(1)%5Bnil%5D-self-and-super/)


### 3. runtimeå¦‚ä½•é€šè¿‡selectoræ‰¾åˆ°å¯¹åº”çš„IMPåœ°å€ï¼Ÿï¼ˆåˆ†åˆ«è€ƒè™‘ç±»æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•ï¼‰

æ¯ä¸€ä¸ªç±»å¯¹è±¡ä¸­éƒ½ä¸€ä¸ªæ–¹æ³•åˆ—è¡¨ï¼Œæ–¹æ³•åˆ—è¡¨ä¸­è®°å½•ç€æ–¹æ³•çš„åç§°ã€æ–¹æ³•å®ç°ã€ä»¥åŠå‚æ•°ç±»å‹ï¼Œå…¶å®selector æœ¬è´¨å°±æ˜¯æ–¹æ³•åç§°ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•åç§°å°±å¯ä»¥åœ¨æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•å®ç°ã€‚

å‚è€ƒ NSObject ä¸Šé¢çš„æ–¹æ³•ï¼š

 ```Objective-C
- (IMP)methodForSelector:(SEL)aSelector;
+ (IMP)instanceMethodForSelector:(SEL)aSelector;
 ```

### 4. ä½¿ç”¨runtime Associateæ–¹æ³•å…³è”çš„å¯¹è±¡ï¼Œéœ€è¦åœ¨ä¸»å¯¹è±¡deallocçš„æ—¶å€™é‡Šæ”¾ä¹ˆï¼Ÿ

 - åœ¨ARCä¸‹ä¸éœ€è¦ã€‚

 - <p><del> åœ¨MRCä¸­,å¯¹äºä½¿ç”¨retainæˆ–copyç­–ç•¥çš„éœ€è¦ ã€‚</del></p>åœ¨MRCä¸‹ä¹Ÿä¸éœ€è¦

> æ— è®ºåœ¨MRCä¸‹è¿˜æ˜¯ARCä¸‹å‡ä¸éœ€è¦ã€‚

```Objective-C
// åœ¨MRCä¸‹ï¼Œä½¿ç”¨runtime Associateæ–¹æ³•å…³è”çš„å¯¹è±¡ï¼Œä¸éœ€è¦åœ¨ä¸»å¯¹è±¡deallocçš„æ—¶å€™é‡Šæ”¾
// http://weibo.com/luohanchenyilong/ (å¾®åš@iOSç¨‹åºçŠ­è¢)
// https://github.com/ChenYilong
// æ‘˜è‡ª2011å¹´ç‰ˆæœ¬çš„Apple API å®˜æ–¹æ–‡æ¡£ - Associative References 

static char overviewKey;
 
NSArray *array =
    [[NSArray alloc] initWithObjects:@"One", @"Two", @"Three", nil];
// For the purposes of illustration, use initWithFormat: to ensure
// the string can be deallocated
NSString *overview =
    [[NSString alloc] initWithFormat:@"%@", @"First three numbers"];
 
objc_setAssociatedObject (
    array,
    &overviewKey,
    overview,
    OBJC_ASSOCIATION_RETAIN
);
 
[overview release];
// (1) overview valid
[array release];
// (2) overview invalid
```

æ–‡æ¡£æŒ‡å‡º 

> At point 1, the string `overview` is still valid because the `OBJC_ASSOCIATION_RETAIN` policy specifies that the array retains the associated object. When the array is deallocated, however (at point 2), `overview` is released and so in this case also deallocated.

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨`[array release];`ä¹‹åï¼Œoverviewå°±ä¼šè¢«releaseé‡Šæ”¾æ‰äº†ã€‚

æ—¢ç„¶ä¼šè¢«é”€æ¯ï¼Œé‚£ä¹ˆå…·ä½“åœ¨ä»€ä¹ˆæ—¶é—´ç‚¹ï¼Ÿ


> æ ¹æ®[ ***WWDC 2011, Session 322 (ç¬¬36åˆ†22ç§’)*** ](https://developer.apple.com/videos/wwdc/2011/#322-video)ä¸­å‘å¸ƒçš„å†…å­˜é”€æ¯æ—¶é—´è¡¨ï¼Œè¢«å…³è”çš„å¯¹è±¡åœ¨ç”Ÿå‘½å‘¨æœŸå†…è¦æ¯”å¯¹è±¡æœ¬èº«é‡Šæ”¾çš„æ™šå¾ˆå¤šã€‚å®ƒä»¬ä¼šåœ¨è¢« NSObject -dealloc è°ƒç”¨çš„ object_dispose() æ–¹æ³•ä¸­é‡Šæ”¾ã€‚

å¯¹è±¡çš„å†…å­˜é”€æ¯æ—¶é—´è¡¨ï¼Œåˆ†å››ä¸ªæ­¥éª¤ï¼š

	// å¯¹è±¡çš„å†…å­˜é”€æ¯æ—¶é—´è¡¨
	// http://weibo.com/luohanchenyilong/ (å¾®åš@iOSç¨‹åºçŠ­è¢)
	// https://github.com/ChenYilong
	// æ ¹æ® WWDC 2011, Session 322 (36åˆ†22ç§’)ä¸­å‘å¸ƒçš„å†…å­˜é”€æ¯æ—¶é—´è¡¨ 
	
	 1. è°ƒç”¨ -release ï¼šå¼•ç”¨è®¡æ•°å˜ä¸ºé›¶
	     * å¯¹è±¡æ­£åœ¨è¢«é”€æ¯ï¼Œç”Ÿå‘½å‘¨æœŸå³å°†ç»“æŸ.
	     * ä¸èƒ½å†æœ‰æ–°çš„ __weak å¼±å¼•ç”¨ï¼Œ å¦åˆ™å°†æŒ‡å‘ nil.
	     * è°ƒç”¨ [self dealloc] 
	 2. å­ç±» è°ƒç”¨ -dealloc
	     * ç»§æ‰¿å…³ç³»ä¸­æœ€åº•å±‚çš„å­ç±» åœ¨è°ƒç”¨ -dealloc
	     * å¦‚æœæ˜¯ MRC ä»£ç  åˆ™ä¼šæ‰‹åŠ¨é‡Šæ”¾å®ä¾‹å˜é‡ä»¬ï¼ˆiVarsï¼‰
	     * ç»§æ‰¿å…³ç³»ä¸­æ¯ä¸€å±‚çš„çˆ¶ç±» éƒ½åœ¨è°ƒç”¨ -dealloc
	 3. NSObject è°ƒ -dealloc
	     * åªåšä¸€ä»¶äº‹ï¼šè°ƒç”¨ Objective-C runtime ä¸­çš„ object_dispose() æ–¹æ³•
	 4. è°ƒç”¨ object_dispose()
	     * ä¸º C++ çš„å®ä¾‹å˜é‡ä»¬ï¼ˆiVarsï¼‰è°ƒç”¨ destructors 
	     * ä¸º ARC çŠ¶æ€ä¸‹çš„ å®ä¾‹å˜é‡ä»¬ï¼ˆiVarsï¼‰ è°ƒç”¨ -release 
	     * è§£é™¤æ‰€æœ‰ä½¿ç”¨ runtime Associateæ–¹æ³•å…³è”çš„å¯¹è±¡
	     * è§£é™¤æ‰€æœ‰ __weak å¼•ç”¨
	     * è°ƒç”¨ free()


å¯¹è±¡çš„å†…å­˜é”€æ¯æ—¶é—´è¡¨ï¼š[å‚è€ƒé“¾æ¥](http://stackoverflow.com/a/10843510/3395008)ã€‚

### 5. addObserver:forKeyPath:options:context:å„ä¸ªå‚æ•°çš„ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Œobserverä¸­éœ€è¦å®ç°å“ªä¸ªæ–¹æ³•æ‰èƒ½è·å¾—KVOå›è°ƒï¼Ÿ

```Objective-C
// æ·»åŠ é”®å€¼è§‚å¯Ÿ
/*
1 è§‚å¯Ÿè€…ï¼Œè´Ÿè´£å¤„ç†ç›‘å¬äº‹ä»¶çš„å¯¹è±¡
2 è§‚å¯Ÿçš„å±æ€§
3 è§‚å¯Ÿçš„é€‰é¡¹
4 ä¸Šä¸‹æ–‡
*/
[self.person addObserver:self forKeyPath:@"name" options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld context:@"Person Name"];
```

observerä¸­éœ€è¦å®ç°ä¸€ä¸‹æ–¹æ³•ï¼š



```Objective-C
// æ‰€æœ‰çš„ kvo ç›‘å¬åˆ°äº‹ä»¶ï¼Œéƒ½ä¼šè°ƒç”¨æ­¤æ–¹æ³•
/*
 1. è§‚å¯Ÿçš„å±æ€§
 2. è§‚å¯Ÿçš„å¯¹è±¡
 3. change å±æ€§å˜åŒ–å­—å…¸ï¼ˆæ–°ï¼æ—§ï¼‰
 4. ä¸Šä¸‹æ–‡ï¼Œä¸ç›‘å¬çš„æ—¶å€™ä¼ é€’çš„ä¸€è‡´
 */
- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary *)change context:(void *)context;
```

### 6. å¦‚ä½•æ‰‹åŠ¨è§¦å‘ä¸€ä¸ªvalueçš„KVO

æ‰€è°“çš„â€œæ‰‹åŠ¨è§¦å‘â€æ˜¯åŒºåˆ«äºâ€œè‡ªåŠ¨è§¦å‘â€ï¼š

è‡ªåŠ¨è§¦å‘æ˜¯æŒ‡ç±»ä¼¼è¿™ç§åœºæ™¯ï¼šåœ¨æ³¨å†Œ KVO ä¹‹å‰è®¾ç½®ä¸€ä¸ªåˆå§‹å€¼ï¼Œæ³¨å†Œä¹‹åï¼Œè®¾ç½®ä¸€ä¸ªä¸ä¸€æ ·çš„å€¼ï¼Œå°±å¯ä»¥è§¦å‘äº†ã€‚

æƒ³çŸ¥é“å¦‚ä½•æ‰‹åŠ¨è§¦å‘ï¼Œå¿…é¡»çŸ¥é“è‡ªåŠ¨è§¦å‘ KVO çš„åŸç†ï¼š

é”®å€¼è§‚å¯Ÿé€šçŸ¥ä¾èµ–äº NSObject çš„ä¸¤ä¸ªæ–¹æ³•:  `willChangeValueForKey:` å’Œ `didChangevlueForKey:` ã€‚åœ¨ä¸€ä¸ªè¢«è§‚å¯Ÿå±æ€§å‘ç”Ÿæ”¹å˜ä¹‹å‰ï¼Œ  `willChangeValueForKey:` ä¸€å®šä¼šè¢«è°ƒç”¨ï¼Œè¿™å°±
ä¼šè®°å½•æ—§çš„å€¼ã€‚è€Œå½“æ”¹å˜å‘ç”Ÿåï¼Œ  `observeValueForKey:ofObject:change:context:` ä¼šè¢«è°ƒç”¨ï¼Œç»§è€Œ `didChangeValueForKey:` ä¹Ÿä¼šè¢«è°ƒç”¨ã€‚å¦‚æœå¯ä»¥æ‰‹åŠ¨å®ç°è¿™äº›è°ƒç”¨ï¼Œå°±å¯ä»¥å®ç°â€œæ‰‹åŠ¨è§¦å‘â€äº†ã€‚

é‚£ä¹ˆâ€œæ‰‹åŠ¨è§¦å‘â€çš„ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿä¸€èˆ¬æˆ‘ä»¬åªåœ¨å¸Œæœ›èƒ½æ§åˆ¶â€œå›è°ƒçš„è°ƒç”¨æ—¶æœºâ€æ—¶æ‰ä¼šè¿™ä¹ˆåšã€‚

å…·ä½“åšæ³•å¦‚ä¸‹ï¼š



å¦‚æœè¿™ä¸ª  `value` æ˜¯  è¡¨ç¤ºæ—¶é—´çš„ `self.now` ï¼Œé‚£ä¹ˆä»£ç å¦‚ä¸‹ï¼šæœ€åä¸¤è¡Œä»£ç ç¼ºä¸€ä¸å¯ã€‚

ç›¸å…³ä»£ç å·²æ”¾åœ¨ä»“åº“é‡Œã€‚

 ```Objective-C
//  .mæ–‡ä»¶
//  Created by https://github.com/ChenYilong
//  å¾®åš@iOSç¨‹åºçŠ­è¢(http://weibo.com/luohanchenyilong/).
//  æ‰‹åŠ¨è§¦å‘ value çš„KVOï¼Œæœ€åä¸¤è¡Œä»£ç ç¼ºä¸€ä¸å¯ã€‚

//@property (nonatomic, strong) NSDate *now;
- (void)viewDidLoad {
    [super viewDidLoad];
    _now = [NSDate date];
    [self addObserver:self forKeyPath:@"now" options:NSKeyValueObservingOptionNew context:nil];
    NSLog(@"1");
    [self willChangeValueForKey:@"now"]; // â€œæ‰‹åŠ¨è§¦å‘self.nowçš„KVOâ€ï¼Œå¿…å†™ã€‚
    NSLog(@"2");
    [self didChangeValueForKey:@"now"]; // â€œæ‰‹åŠ¨è§¦å‘self.nowçš„KVOâ€ï¼Œå¿…å†™ã€‚
    NSLog(@"4");
}
 ```

ä½†æ˜¯å¹³æ—¶æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šè¿™ä¹ˆå¹²ï¼Œæˆ‘ä»¬éƒ½æ˜¯ç­‰ç³»ç»Ÿå»â€œè‡ªåŠ¨è§¦å‘â€ã€‚â€œè‡ªåŠ¨è§¦å‘â€çš„å®ç°åŸç†ï¼š


 > æ¯”å¦‚è°ƒç”¨ `setNow:` æ—¶ï¼Œç³»ç»Ÿè¿˜ä¼šä»¥æŸç§æ–¹å¼åœ¨ä¸­é—´æ’å…¥ `wilChangeValueForKey:` ã€  `didChangeValueForKey:` å’Œ `observeValueForKeyPath:ofObject:change:context:` çš„è°ƒç”¨ã€‚


å¤§å®¶å¯èƒ½ä»¥ä¸ºè¿™æ˜¯å› ä¸º `setNow:` æ˜¯åˆæˆæ–¹æ³•ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ä¹Ÿèƒ½çœ‹åˆ°æœ‰äººè¿™ä¹ˆå†™ä»£ç :

 ```Objective-C
- (void)setNow:(NSDate *)aDate {
    [self willChangeValueForKey:@"now"]; // æ²¡æœ‰å¿…è¦
    _now = aDate;
    [self didChangeValueForKey:@"now"];// æ²¡æœ‰å¿…è¦
}
 ```

è¿™å®Œå…¨æ²¡æœ‰å¿…è¦ï¼Œä¸è¦è¿™ä¹ˆåšï¼Œè¿™æ ·çš„è¯ï¼ŒKVOä»£ç ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ã€‚KVOåœ¨è°ƒç”¨å­˜å–æ–¹æ³•ä¹‹å‰æ€»æ˜¯è°ƒç”¨ `willChangeValueForKey:`  ï¼Œä¹‹åæ€»æ˜¯è°ƒç”¨ `didChangeValueForkey:` ã€‚æ€ä¹ˆåšåˆ°çš„å‘¢?ç­”æ¡ˆæ˜¯é€šè¿‡ isa æ··å†™ï¼ˆisa-swizzlingï¼‰ã€‚ä¸‹æ–‡ã€Šappleç”¨ä»€ä¹ˆæ–¹å¼å®ç°å¯¹ä¸€ä¸ªå¯¹è±¡çš„KVOï¼Ÿã€‹ä¼šæœ‰è¯¦è¿°ã€‚


å…¶ä¸­ä¼šè§¦å‘ä¸¤æ¬¡ï¼Œå…·ä½“åŸå› å¯ä»¥æŸ¥çœ‹æ–‡æ¡£[Apple document : Key-Value Observing Programming Guide-Manual Change Notification]( https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOCompliance.html#//apple_ref/doc/uid/20002178-SW3 "") ï¼Œä¸»è¦æ˜¯ `+automaticallyNotifiesObserversForKey:` ç±»æ–¹æ³•äº†ã€‚



### 7. è‹¥ä¸€ä¸ªç±»æœ‰å®ä¾‹å˜é‡ `NSString *_foo` ï¼Œè°ƒç”¨setValue:forKey:æ—¶ï¼Œå¯ä»¥ä»¥fooè¿˜æ˜¯ `_foo` ä½œä¸ºkeyï¼Ÿ

éƒ½å¯ä»¥ã€‚

### 8. KVCçš„keyPathä¸­çš„é›†åˆè¿ç®—ç¬¦å¦‚ä½•ä½¿ç”¨ï¼Ÿ

  1. å¿…é¡»ç”¨åœ¨é›†åˆå¯¹è±¡ä¸Šæˆ–æ™®é€šå¯¹è±¡çš„é›†åˆå±æ€§ä¸Š
  2. ç®€å•é›†åˆè¿ç®—ç¬¦æœ‰@avgï¼Œ @count ï¼Œ @max ï¼Œ @min ï¼Œ@sumï¼Œ
  3. æ ¼å¼ @"@sum.age"æˆ– @"é›†åˆå±æ€§.@max.age"

### 9. KVCå’ŒKVOçš„keyPathä¸€å®šæ˜¯å±æ€§ä¹ˆï¼Ÿ

KVC æ”¯æŒå®ä¾‹å˜é‡ï¼ŒKVO åªèƒ½æ‰‹åŠ¨æ”¯æŒ[æ‰‹åŠ¨è®¾å®šå®ä¾‹å˜é‡çš„KVOå®ç°ç›‘å¬](https://yq.aliyun.com/articles/30483)

### 10. å¦‚ä½•å…³é—­é»˜è®¤çš„KVOçš„é»˜è®¤å®ç°ï¼Œå¹¶è¿›å…¥è‡ªå®šä¹‰çš„KVOå®ç°ï¼Ÿ


è¯·å‚è€ƒï¼š

    1. [ã€Šå¦‚ä½•è‡ªå·±åŠ¨æ‰‹å®ç° KVOã€‹](http://tech.glowing.com/cn/implement-kvo/)
    2. [**KVO for manually implemented properties**]( http://stackoverflow.com/a/10042641/3395008 ) 

### 11. appleç”¨ä»€ä¹ˆæ–¹å¼å®ç°å¯¹ä¸€ä¸ªå¯¹è±¡çš„KVOï¼Ÿ 

[Apple çš„æ–‡æ¡£](https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOImplementation.html)å¯¹ KVO å®ç°çš„æè¿°ï¼š

 > Automatic key-value observing is implemented using a technique called isa-swizzling... When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class ...

ä»[Apple çš„æ–‡æ¡£](https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOImplementation.html)å¯ä»¥çœ‹å‡ºï¼šApple å¹¶ä¸å¸Œæœ›è¿‡å¤šæš´éœ² KVO çš„å®ç°ç»†èŠ‚ã€‚ä¸è¿‡ï¼Œè¦æ˜¯å€ŸåŠ© runtime æä¾›çš„æ–¹æ³•å»æ·±å…¥æŒ–æ˜ï¼Œæ‰€æœ‰è¢«æ©ç›–çš„ç»†èŠ‚éƒ½ä¼šåŸå½¢æ¯•éœ²ï¼š

 > å½“ä½ è§‚å¯Ÿä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä¸€ä¸ªæ–°çš„ç±»ä¼šè¢«åŠ¨æ€åˆ›å»ºã€‚è¿™ä¸ªç±»ç»§æ‰¿è‡ªè¯¥å¯¹è±¡çš„åŸæœ¬çš„ç±»ï¼Œå¹¶é‡å†™äº†è¢«è§‚å¯Ÿå±æ€§çš„ setter æ–¹æ³•ã€‚é‡å†™çš„ setter æ–¹æ³•ä¼šè´Ÿè´£åœ¨è°ƒç”¨åŸ setter æ–¹æ³•ä¹‹å‰å’Œä¹‹åï¼Œé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿå¯¹è±¡ï¼šå€¼çš„æ›´æ”¹ã€‚æœ€åé€šè¿‡ ` isa æ··å†™ï¼ˆisa-swizzlingï¼‰` æŠŠè¿™ä¸ªå¯¹è±¡çš„ isa æŒ‡é’ˆ ( isa æŒ‡é’ˆå‘Šè¯‰ Runtime ç³»ç»Ÿè¿™ä¸ªå¯¹è±¡çš„ç±»æ˜¯ä»€ä¹ˆ ) æŒ‡å‘è¿™ä¸ªæ–°åˆ›å»ºçš„å­ç±»ï¼Œå¯¹è±¡å°±ç¥å¥‡çš„å˜æˆäº†æ–°åˆ›å»ºçš„å­ç±»çš„å®ä¾‹ã€‚æˆ‘ç”»äº†ä¸€å¼ ç¤ºæ„å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š


<p align="center"><a href="https://mp.weixin.qq.com/s/A4e5h3xgIEh6PInf1Rjqsw"><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfec69ggukj30qh0fvjta.jpg"></a></p>


 KVO ç¡®å®æœ‰ç‚¹é»‘é­”æ³•ï¼š


 > Apple ä½¿ç”¨äº† ` isa æ··å†™ï¼ˆisa-swizzlingï¼‰`æ¥å®ç° KVO ã€‚


ä¸‹é¢åšä¸‹è¯¦ç»†è§£é‡Šï¼š

é”®å€¼è§‚å¯Ÿé€šçŸ¥ä¾èµ–äº NSObject çš„ä¸¤ä¸ªæ–¹æ³•:  `willChangeValueForKey:` å’Œ `didChangevlueForKey:` ã€‚åœ¨ä¸€ä¸ªè¢«è§‚å¯Ÿå±æ€§å‘ç”Ÿæ”¹å˜ä¹‹å‰ï¼Œ  `willChangeValueForKey:` ä¸€å®šä¼šè¢«è°ƒç”¨ï¼Œè¿™å°±ä¼šè®°å½•æ—§çš„å€¼ã€‚è€Œå½“æ”¹å˜å‘ç”Ÿåï¼Œ `observeValueForKey:ofObject:change:context:` ä¼šè¢«è°ƒç”¨ï¼Œç»§è€Œ  `didChangeValueForKey:` ä¹Ÿä¼šè¢«è°ƒç”¨ã€‚å¯ä»¥æ‰‹åŠ¨å®ç°è¿™äº›è°ƒç”¨ï¼Œä½†å¾ˆå°‘æœ‰äººè¿™ä¹ˆåšã€‚ä¸€èˆ¬æˆ‘ä»¬åªåœ¨å¸Œæœ›èƒ½æ§åˆ¶å›è°ƒçš„è°ƒç”¨æ—¶æœºæ—¶æ‰ä¼šè¿™ä¹ˆåšã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæ”¹å˜é€šçŸ¥ä¼šè‡ªåŠ¨è°ƒç”¨ã€‚

 æ¯”å¦‚è°ƒç”¨ `setNow:` æ—¶ï¼Œç³»ç»Ÿè¿˜ä¼šä»¥æŸç§æ–¹å¼åœ¨ä¸­é—´æ’å…¥ `wilChangeValueForKey:` ã€  `didChangeValueForKey:`  å’Œ `observeValueForKeyPath:ofObject:change:context:` çš„è°ƒç”¨ã€‚å¤§å®¶å¯èƒ½ä»¥ä¸ºè¿™æ˜¯å› ä¸º `setNow:` æ˜¯åˆæˆæ–¹æ³•ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ä¹Ÿèƒ½çœ‹åˆ°æœ‰äººè¿™ä¹ˆå†™ä»£ç :

 ```Objective-C
- (void)setNow:(NSDate *)aDate {
    [self willChangeValueForKey:@"now"]; // æ²¡æœ‰å¿…è¦
    _now = aDate;
    [self didChangeValueForKey:@"now"];// æ²¡æœ‰å¿…è¦
}
 ```

è¿™å®Œå…¨æ²¡æœ‰å¿…è¦ï¼Œä¸è¦è¿™ä¹ˆåšï¼Œè¿™æ ·çš„è¯ï¼ŒKVOä»£ç ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ã€‚KVOåœ¨è°ƒç”¨å­˜å–æ–¹æ³•ä¹‹å‰æ€»æ˜¯è°ƒç”¨ `willChangeValueForKey:`  ï¼Œä¹‹åæ€»æ˜¯è°ƒç”¨ `didChangeValueForkey:` ã€‚æ€ä¹ˆåšåˆ°çš„å‘¢?ç­”æ¡ˆæ˜¯é€šè¿‡ isa æ··å†™ï¼ˆisa-swizzlingï¼‰ã€‚ç¬¬ä¸€æ¬¡å¯¹ä¸€ä¸ªå¯¹è±¡è°ƒç”¨ `addObserver:forKeyPath:options:context:` æ—¶ï¼Œæ¡†æ¶ä¼šåˆ›å»ºè¿™ä¸ªç±»çš„æ–°çš„ KVO å­ç±»ï¼Œå¹¶å°†è¢«è§‚å¯Ÿå¯¹è±¡è½¬æ¢ä¸ºæ–°å­ç±»çš„å¯¹è±¡ã€‚åœ¨è¿™ä¸ª KVO ç‰¹æ®Šå­ç±»ä¸­ï¼Œ Cocoa åˆ›å»ºè§‚å¯Ÿå±æ€§çš„ setter ï¼Œå¤§è‡´å·¥ä½œåŸç†å¦‚ä¸‹:

 ```Objective-C
- (void)setNow:(NSDate *)aDate {
    [self willChangeValueForKey:@"now"];
    [super setValue:aDate forKey:@"now"];
    [self didChangeValueForKey:@"now"];
}
 ```

è¿™ç§ç»§æ‰¿å’Œæ–¹æ³•æ³¨å…¥æ˜¯åœ¨è¿è¡Œæ—¶è€Œä¸æ˜¯ç¼–è¯‘æ—¶å®ç°çš„ã€‚è¿™å°±æ˜¯æ­£ç¡®å‘½åå¦‚æ­¤é‡è¦çš„åŸå› ã€‚åªæœ‰åœ¨ä½¿ç”¨KVCå‘½åçº¦å®šæ—¶ï¼ŒKVOæ‰èƒ½åšåˆ°è¿™ä¸€ç‚¹ã€‚

KVO åœ¨å®ç°ä¸­é€šè¿‡ ` isa æ··å†™ï¼ˆisa-swizzlingï¼‰` æŠŠè¿™ä¸ªå¯¹è±¡çš„ isa æŒ‡é’ˆ ( isa æŒ‡é’ˆå‘Šè¯‰ Runtime ç³»ç»Ÿè¿™ä¸ªå¯¹è±¡çš„ç±»æ˜¯ä»€ä¹ˆ ) æŒ‡å‘è¿™ä¸ªæ–°åˆ›å»ºçš„å­ç±»ï¼Œå¯¹è±¡å°±ç¥å¥‡çš„å˜æˆäº†æ–°åˆ›å»ºçš„å­ç±»çš„å®ä¾‹ã€‚è¿™åœ¨[Apple çš„æ–‡æ¡£](https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOImplementation.html)å¯ä»¥å¾—åˆ°å°è¯ï¼š

 > Automatic key-value observing is implemented using a technique called isa-swizzling... When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class ...


ç„¶è€Œ KVO åœ¨å®ç°ä¸­ä½¿ç”¨äº† ` isa æ··å†™ï¼ˆ isa-swizzlingï¼‰` ï¼Œè¿™ä¸ªçš„ç¡®ä¸æ˜¯å¾ˆå®¹æ˜“å‘ç°ï¼šApple è¿˜é‡å†™ã€è¦†ç›–äº† `-class` æ–¹æ³•å¹¶è¿”å›åŸæ¥çš„ç±»ã€‚ ä¼å›¾æ¬ºéª—æˆ‘ä»¬ï¼šè¿™ä¸ªç±»æ²¡æœ‰å˜ï¼Œå°±æ˜¯åŸæœ¬é‚£ä¸ªç±»ã€‚ã€‚ã€‚

ä½†æ˜¯ï¼Œå‡è®¾â€œè¢«ç›‘å¬çš„å¯¹è±¡â€çš„ç±»å¯¹è±¡æ˜¯ `MYClass` ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬èƒ½çœ‹åˆ°å¯¹ `NSKVONotifying_MYClass` çš„å¼•ç”¨è€Œä¸æ˜¯å¯¹  `MYClass`  çš„å¼•ç”¨ã€‚å€Ÿæ­¤æˆ‘ä»¬å¾—ä»¥çŸ¥é“ Apple ä½¿ç”¨äº† ` isa æ··å†™ï¼ˆisa-swizzlingï¼‰`ã€‚å…·ä½“æ¢ç©¶è¿‡ç¨‹å¯å‚è€ƒ[ è¿™ç¯‡åšæ–‡ ](https://www.mikeash.com/pyblog/friday-qa-2009-01-23.html)ã€‚


é‚£ä¹ˆ `wilChangeValueForKey:` ã€  `didChangeValueForKey:`  å’Œ `observeValueForKeyPath:ofObject:change:context:` è¿™ä¸‰ä¸ªæ–¹æ³•çš„æ‰§è¡Œé¡ºåºæ˜¯æ€æ ·çš„å‘¢ï¼Ÿ

 `wilChangeValueForKey:` ã€  `didChangeValueForKey:` å¾ˆå¥½ç†è§£ï¼Œ`observeValueForKeyPath:ofObject:change:context:` çš„æ‰§è¡Œæ—¶æœºæ˜¯ä»€ä¹ˆæ—¶å€™å‘¢ï¼Ÿ

 å…ˆçœ‹ä¸€ä¸ªä¾‹å­ï¼š

ä»£ç å·²æ”¾åœ¨ä»“åº“é‡Œã€‚

 ```Objective-C
- (void)viewDidLoad {
    [super viewDidLoad];
    [self addObserver:self forKeyPath:@"now" options:NSKeyValueObservingOptionNew context:nil];
    NSLog(@"1");
    [self willChangeValueForKey:@"now"]; // â€œæ‰‹åŠ¨è§¦å‘self.nowçš„KVOâ€ï¼Œå¿…å†™ã€‚
    NSLog(@"2");
    [self didChangeValueForKey:@"now"]; // â€œæ‰‹åŠ¨è§¦å‘self.nowçš„KVOâ€ï¼Œå¿…å†™ã€‚
    NSLog(@"4");
}

- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary<NSString *,id> *)change context:(void *)context {
    NSLog(@"3");
}

 ```



å¦‚æœå•å•ä»ä¸‹é¢è¿™ä¸ªä¾‹å­çš„æ‰“å°ä¸Šï¼Œ 

é¡ºåºä¼¼ä¹æ˜¯ `wilChangeValueForKey:` ã€ `observeValueForKeyPath:ofObject:change:context:` ã€ `didChangeValueForKey:` ã€‚

å…¶å®ä¸ç„¶ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ª `observeValueForKeyPath:ofObject:change:context:`  , å’Œ `didChangeValueForKey:` åˆ°åº•è°å…ˆè°ƒç”¨çš„é—®é¢˜ï¼šå¦‚æœ `observeValueForKeyPath:ofObject:change:context:` æ˜¯åœ¨ `didChangeValueForKey:` å†…éƒ¨è§¦å‘çš„æ“ä½œå‘¢ï¼Ÿ é‚£ä¹ˆé¡ºåºå°±æ˜¯ï¼š `wilChangeValueForKey:` ã€  `didChangeValueForKey:`  å’Œ `observeValueForKeyPath:ofObject:change:context:` 

ä¸ä¿¡ä½ æŠŠ `didChangeValueForKey:` æ³¨è§†æ‰ï¼Œçœ‹ä¸‹ `observeValueForKeyPath:ofObject:change:context:` ä¼šä¸ä¼šæ‰§è¡Œã€‚

äº†è§£åˆ°è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œæ­£å¦‚  [46. å¦‚ä½•æ‰‹åŠ¨è§¦å‘ä¸€ä¸ªvalueçš„KVO](https://github.com/ChenYilong/iOSInterviewQuestions/blob/master/01ã€Šæ‹›è˜ä¸€ä¸ªé è°±çš„iOSã€‹é¢è¯•é¢˜å‚è€ƒç­”æ¡ˆ/ã€Šæ‹›è˜ä¸€ä¸ªé è°±çš„iOSã€‹é¢è¯•é¢˜å‚è€ƒç­”æ¡ˆï¼ˆä¸‹ï¼‰.md#46-å¦‚ä½•æ‰‹åŠ¨è§¦å‘ä¸€ä¸ªvalueçš„kvo)  æ‰€è¯´çš„ï¼š

â€œæ‰‹åŠ¨è§¦å‘â€çš„ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿä¸€èˆ¬æˆ‘ä»¬åªåœ¨å¸Œæœ›èƒ½æ§åˆ¶â€œå›è°ƒçš„è°ƒç”¨æ—¶æœºâ€æ—¶æ‰ä¼šè¿™ä¹ˆåšã€‚

è€Œâ€œå›è°ƒçš„è°ƒç”¨æ—¶æœºâ€å°±æ˜¯åœ¨ä½ è°ƒç”¨ `didChangeValueForKey:` æ–¹æ³•æ—¶ã€‚



### 12ã€kvoæ‰‹åŠ¨è§¦å‘,å¦‚æœåªå®ç°ä¸€åŠä¼šæœ‰ä»€ä¹ˆé—®é¢˜

```objective-c
    [self willChangeValueForKey:@"age"];
    _age = age;
    [self didChangeValueForKey:@"age"];
```

`willChangeValueForKey`ä¼šå­˜å‚¨æ—§å€¼ï¼Œå¦‚æœåªå®ç°å‰åŠä¸ªå¯èƒ½ä¼šå†…å­˜æ³„æ¼ã€‚

å¦‚æœåªè°ƒç”¨`didChangeValueForKey`åŒæ ·ä¸ä¼šè§¦å‘ã€‚

### 13ã€RACä¸‹setæ–¹æ³•å¦‚ä½•å®ç°

```objective-c
str = [[NSString alloc]init];
str = [[NSString alloc]init];
```

### 14ã€NSClassFromString()å®ç°åŸç†



