# å¯¹è±¡çš„æœ¬è´¨åŠåˆ†ç±»

# ä¸€ã€åˆ†æ

## 1.1 å¯¹è±¡çš„åˆ†ç±»

Objective-Cä¸­çš„å¯¹è±¡ï¼Œç®€ç§°OCå¯¹è±¡ï¼Œä¸»è¦å¯ä»¥åˆ†ä¸º3ç§ï¼š

- instanceå¯¹è±¡ï¼ˆå®ä¾‹å¯¹è±¡ï¼‰
- classå¯¹è±¡ï¼ˆç±»å¯¹è±¡ï¼‰
- meta-classå¯¹è±¡ï¼ˆå…ƒç±»å¯¹è±¡ï¼‰

### 1.1.1 [NSObject class]

```c++
+ (Class)class {
    return self;
}
```

è¿”å›ç±»å¯¹è±¡ï¼ˆå…ƒç±»å¯¹è±¡ï¼‰æœ¬èº«ã€‚

æ‰€ä»¥ï¼Œ`[[[NSObject class] class] class]` æ— è®ºè°ƒç”¨å¤šå°‘æ¬¡classï¼Œå…¶è¿”å›éƒ½æ˜¯NSObject classå¯¹è±¡ã€‚

### 1.1.2 [person class]

```c++
- (Class)class {
    return object_getClass(self);
}
```

```c++
Class object_getClass(id obj)
{
    if (obj) return obj->getIsa();
    else return Nil;
}
```

- [person class]ï¼šè¿”å›person1ä¸­isaæŒ‡å‘çš„å¯¹è±¡ï¼Œå°±æ˜¯BFPerson classå¯¹è±¡ï¼›

è¿”å›ä¼ å…¥`obj`ä¸­`isa`æ‰€æŒ‡å‘çš„å¯¹è±¡ï¼Œä¼ å…¥çš„objå¯èƒ½æ˜¯`instance`å¯¹è±¡ã€`class`å¯¹è±¡ã€`meta-class`å¯¹è±¡

å…¶è¿”å›å€¼å¯¹åº”ä¸ºï¼š

a) å¦‚æœæ˜¯`instance`å¯¹è±¡ï¼Œè¿”å›`class`å¯¹è±¡

b) å¦‚æœæ˜¯`class`å¯¹è±¡ï¼Œè¿”å›`meta-class`å¯¹è±¡

c) å¦‚æœæ˜¯`meta-class`å¯¹è±¡ï¼Œè¿”å›NSObjectï¼ˆåŸºç±»ï¼‰çš„`meta-class`å¯¹è±¡

### 1.1.3 objc_getClass

è¯¥æ–¹æ³•ä¸object_getClassä»æ–¹æ³•åçœ‹æå…¶ç›¸ä¼¼ã€‚ã€‚

- å‚æ•°ï¼šå­—ç¬¦ä¸²ç±»åï¼›
- è¿”å›ï¼šå¯¹åº”çš„ç±»å¯¹è±¡ã€‚

```c++
Class objc_getClass(const char *aClassName)
{
    if (!aClassName) return Nil;
    // NO unconnected, YES class handler
    return look_up_class(aClassName, NO, YES);
}
```

NSClassFromString()ä¼šè°ƒç”¨æ­¤æ–¹æ³•ã€‚

## 1.2 ä¸€äº›ä»æºç æ¥çš„ç»“æ„ä½“

### 1.2.1 `NSObject`

NSObjectä»æºç ä¸­å¾—åˆ°ï¼Œå…¶ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡ä¸º`isa`ï¼Œè¯¥`Class`ç»“æ„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡åç§°ä¹Ÿæ˜¯`isa`ã€‚

`isa`é‡Œåˆ™åŒ…å«äº†ï¼ˆå…ƒï¼‰ç±»ä¿¡æ¯çš„å­˜æ”¾åœ°å€ã€‚

### 1.2.2 `class_rw_t`

`class_rw_t`ã€`class_ro_t`å‡æ˜¯å­˜æ”¾ç±»ä¸­ä¿¡æ¯çš„ç»“æ„ä½“ï¼ŒåŒ…æ‹¬æˆå‘˜å˜é‡ã€å±æ€§åˆ—è¡¨ã€åè®®åˆ—è¡¨åŠæ–¹æ³•åˆ—è¡¨ï¼Œå…¶å…·ä½“å¦‚ä¸‹ï¼š

![image-20181122114716755](https://raw.githubusercontent.com/awanglilong/blog/main/uPic/2018-11-22-034717.png)

ç›®å‰ï¼Œæˆ‘ä»¬`class_ro_t`**å½“å‰ç±»åœ¨ç¼–è¯‘æœŸå°±å·²ç»ç¡®å®šçš„å±æ€§ã€æ–¹æ³•ä»¥åŠéµå¾ªçš„åè®®**ã€‚

`class_rw_t`åˆ™æ˜¯åœ¨**è¿è¡Œæ—¶ï¼Œruntimeé‡æ–°åŠ è½½å¸ƒå±€çš„å½“å‰ç±»çš„å±æ€§ã€æ–¹æ³•å’Œåè®®ç­‰ã€‚**

### 1.2.3 `method_t`

- `method_t`æ˜¯ æ–¹æ³•æœ€åº•å±‚çš„ç»“æ„ã€‚
- `method_list_t`
  - æ–¹æ³•åˆ—è¡¨ï¼Œä¸€ç»´æ•°ç»„
  - å†…éƒ¨å­˜æ”¾`method_t`
  - `class_ro_t`ä¸­çš„æˆå‘˜å˜é‡ã€‚
- `method_array_t`
  - åŒæ ·æ˜¯æ–¹æ³•åˆ—è¡¨ï¼Œä½†æ˜¯æ˜¯äºŒç»´æ•°ç»„
  - å†…éƒ¨å­˜æ”¾`method_t`
  - `class_rw_t`ä¸­çš„æˆå‘˜å˜é‡;

ä¸‰è€…çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š

![image-20181122114848636](https://raw.githubusercontent.com/awanglilong/blog/main/uPic/2018-11-22-034849.png)

### 1.2.4 `property_t`

`property_array_t `ä¸`property_list_t`çš„ç»“æ„ä¸ä¸Šé¢çš„methodä¸­çš„æ•°ç»„ç±»ä¼¼ï¼Œåˆ†åˆ«æ˜¯äºŒç»´ã€ä¸€ç»´æ•°ç»„ã€‚

```c++
struct property_t {
    const char *name;  		 //å±æ€§å
    const char *attributes;  //å­—ç¬¦ä¸²ï¼Œè¡¨æ˜äº†è¯¥å±æ€§çš„ç‰¹æ€§
};
```

å‡å¦‚å±æ€§åä¸ºnameï¼Œç±»å‹ä¸ºNSStringï¼Œé‚£ä¹ˆå¯¹åº”çš„attributesï¼šT@â€NSStringâ€,C,N,V_name

### 1.2.5 `protocol_t`

`protocol_array_t`ã€`protocol_list_t`åˆ†åˆ«æ˜¯å­˜æ”¾`protocol_t`çš„äºŒç»´åŠä¸€ç»´æ•°ç»„ã€‚

ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬å…³æ³¨`protocol_t`ç»“æ„ä½“ï¼š

```c++
struct protocol_t : objc_object {
    const char *mangledName;
    struct protocol_list_t *protocols;
    method_list_t *instanceMethods;
    method_list_t *classMethods;
    method_list_t *optionalInstanceMethods;
    method_list_t *optionalClassMethods;
    property_list_t *instanceProperties;
    uint32_t size;   // sizeof(protocol_t)
    uint32_t flags;
    // Fields below this point are not always present on disk.
    const char **_extendedMethodTypes;
    const char *_demangledName;
    property_list_t *_classProperties;
};
```

- mangledNameå’Œ_demangledName
   è¿™ä¸ªä¸œè¥¿æ¥æºäºc++çš„name manglingï¼ˆå‘½åé‡æ•´ï¼‰æŠ€æœ¯ï¼Œåœ¨c++é‡Œé¢æ˜¯ç”¨æ¥åŒºåˆ«é‡è½½æ—¶çš„å‡½æ•°ã€‚
- instanceMethodså’ŒoptionalInstanceMethods
   å¯¹åº”çš„æ˜¯å®ä¾‹æ–¹æ³•ï¼Œå¯é€‰å®ä¾‹æ–¹æ³•ï¼Œå¯é€‰å°±æ˜¯å†™åœ¨@optionalä¹‹åçš„æ–¹æ³•ã€‚
- classMethodså’ŒoptionalClassMethods
   ä¸ä¸Šé¢å¯¹åº”ï¼Œåˆ†åˆ«æ˜¯ç±»æ–¹æ³•ï¼Œå¯é€‰ç±»æ–¹æ³•
- instanceProperties
   å®ä¾‹å±æ€§ã€‚å¥‡æ€ªçš„æ˜¯è¿™é‡Œä¸ºä»€ä¹ˆä¸åŒºåˆ†å¿…é¡»è¿˜æ˜¯å¯é€‰ï¼Ÿ
- _classProperties
   ç±»å±æ€§ã€‚æŒºå°‘è§çš„ï¼Œä¸¾ä¸ªä¾‹å­ï¼š

```objective-c
// è¿™æ˜¯å¸¸è§çš„å±æ€§å£°æ˜ï¼Œä¹Ÿå°±æ˜¯å¯¹è±¡å±æ€§
@property (nonatomic, assign) NSInteger count;
// è¿™æ˜¯ç±»å±æ€§ï¼Œä¸ç±»æ–¹æ³•ä¸€æ ·ï¼Œé€šè¿‡ç±»åè°ƒç”¨
@property (class, nonatomic, copy) NSString *name;
```

- protocols
   æ­¤åè®®éµå¾ªçš„åè®®

### 1.2.6 `ivar_t`

æˆ‘ä»¬å‘ç°ï¼Œé’ˆå¯¹æˆå‘˜å˜é‡ï¼Œåªæœ‰`ivar_list_t`ï¼Œè€Œæ²¡æœ‰`ivar_array_t`è¿™æ ·çš„ç»“æ„ã€‚

ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå°±ç®—æ˜¯runtimeï¼Œä¹Ÿæ— æ³•åœ¨è¿è¡Œæ—¶å¾€ç±»ä¸­æ·»åŠ æˆå‘˜å˜é‡ã€‚

```c++
struct ivar_t {
    int32_t *offset;
    const char *name;
    const char *type;
    // alignment is sometimes -1; use alignment() instead
    uint32_t alignment_raw;
    uint32_t size;
};
```



### 1.2.7 NSClassFromString

[ä»æ±‡ç¼–ä»£ç æ¢ç©¶ NSClassFromString å®ç°](https://juejin.cn/post/6844903686175457288#heading-27)åˆ†æNSClassFromStringå®ç°å¤§ä½“å¦‚ä¸‹.

```c
Class _Nullable NSClassFromString(NSString *aClassName) {
    if (!aClassName) { return Nil; }
    
    NSUInteger classNameLength = [aClassName length];
    char buffer[1000];
    
    // @"Big\0Dog" ä»¥åŠ @"ğŸ¶" éƒ½ä¼šä½¿å¾—
    // classNameLength == strlen(buffer) ä¸æˆç«‹
    if ([aClassName getCString:buffer maxLength:1000 encoding:NSUTF8StringEncoding]
        && classNameLength == strlen(buffer)) {
        return objc_lookUpClass(buffer);
    } else if (classNameLength == 0) {
        // æ£€æŸ¥æ˜¯å¦ç©ºå­—ç¬¦ä¸² @""ï¼Œè¿™ä¸ªåˆ†æ”¯è¦å¤„ç†çš„æƒ…å†µä¸å¤ªç†è§£
        return objc_lookUpClass([aClassName UTF8String]);
    }
    
    for (int i = 0; i < classNameLength; i++) {
        // å¦‚æœ aClassName ä¸­å«æœ‰ \0 å­—ç¬¦ï¼Œå‘å¤–è¿”å› Nil
        // æ¯”å¦‚ @"Big\0Dog" çš„æƒ…å†µ
        if ([aClassName characterAtIndex:i] == 0) {
            return Nil;
        }
    }
    
    return objc_lookUpClass([aClassName UTF8String]);
}
```

ä¹Ÿå°±æ˜¯è¯´`NSClassFromString`æœ€ç»ˆä¼šè°ƒç”¨`objc_lookUpClass`æ–¹æ³•

```c
/***********************************************************************
* look_up_class
* Map a class name to a class using various methods.
* This is the common implementation of objc_lookUpClass and objc_getClass, 
* and is also used internally to get additional search options.
* Sequence:
* 1. class_hash
* 2. unconnected_class_hash (optional)
* 3. classLoader callback
* 4. classHandler callback (optional)
**********************************************************************/
Class look_up_class(const char *aClassName, bool includeUnconnected, 
                    bool includeClassHandler)
{
    bool includeClassLoader = YES; // class loader cannot be skipped
    Class result = nil;
    struct objc_class query;

    query.name = aClassName;

 retry:

    if (!result  &&  class_hash) {
        // Check ordinary classes
        mutex_locker_t lock(classLock);
        result = (Class)NXHashGet(class_hash, &query);
    }

    if (!result  &&  includeUnconnected  &&  unconnected_class_hash) {
        // Check not-yet-connected classes
        mutex_locker_t lock(classLock);
        result = (Class)NXHashGet(unconnected_class_hash, &query);
    }

    if (!result  &&  includeClassLoader  &&  _objc_classLoader) {
        // Try class loader callback
        if ((*_objc_classLoader)(aClassName)) {
            // Re-try lookup without class loader
            includeClassLoader = NO;
            goto retry;
        }
    }

    if (!result  &&  includeClassHandler  &&  objc_classHandler) {
        // Try class handler callback
        if ((*objc_classHandler)(aClassName)) {
            // Re-try lookup without class handler or class loader
            includeClassLoader = NO;
            includeClassHandler = NO;
            goto retry;
        }
    }

    return result;
}
```

objc_lookUpClassé€šè¿‡ä¸€ä¸ªé€šè¿‡NXHashGetæ–¹æ³•ï¼ŒæŸ¥æ‰¾ä¸€ä¸ªæ–¹æ³•åçš„hashè¡¨.

```c
/***********************************************************************
* getClassExceptSomeSwift
* Looks up a class by name. The class MIGHT NOT be realized.
* Demangled Swift names are recognized.
* Classes known to the Swift runtime but not yet used are NOT recognized.
*   (such as subclasses of un-instantiated generics)
* Use look_up_class() to find them as well.
* Locking: runtimeLock must be read- or write-locked by the caller.
**********************************************************************/

// This is a misnomer: gdb_objc_realized_classes is actually a list of 
// named classes not in the dyld shared cache, whether realized or not.
// This list excludes lazily named classes, which have to be looked up
// using a getClass hook.
NXMapTable *gdb_objc_realized_classes;  // exported for debuggers in objc-gdb.h

static Class getClass_impl(const char *name)
{
    runtimeLock.assertLocked();

    // allocated in _read_images
    ASSERT(gdb_objc_realized_classes);

    // Try runtime-allocated table
    Class result = (Class)NXMapGet(gdb_objc_realized_classes, name);
    if (result) return result;

    // Try table from dyld shared cache.
    // Note we do this last to handle the case where we dlopen'ed a shared cache
    // dylib with duplicates of classes already present in the main executable.
    // In that case, we put the class from the main executable in
    // gdb_objc_realized_classes and want to check that before considering any
    // newly loaded shared cache binaries.
    return getPreoptimizedClass(name);
}
```



## 1.3 NSObjectå®ä¾‹å¯¹è±¡çš„å†…å­˜

**ç¼–è¯‘æœŸ**çš„`isa`æŒ‡å‘`classs_ro_t`

**è¿è¡ŒæœŸ**çš„`isa`æŒ‡å‘`classs_rw_t`



# ä¸‰ã€isaå’Œsuperclass

`isa`åœ¨å¹³æ—¶å¼€å‘ä¸­å¾ˆå°‘ä½¿ç”¨ï¼Œä½†æ˜¯ç›¸ä¿¡å¾ˆå¤šiOSå¼€å‘è€…å¹¶ä¸é™Œç”Ÿã€‚

åœ¨å‰é¢äº†è§£äº†NSObjectã€å„ç§ç»“æ„ä½“åŠå¯¹è±¡ä¸‰å¤§åˆ†ç±»ä¹‹åï¼Œè‹¹æœä¸ºæˆ‘ä»¬æä¾›äº†çš„Cocoa/Cocoa Touchä¸­ï¼Œç±»è”Ÿä½“ç³»çš„å»ºç«‹ä¾èµ–ä¸¤ä¸ªæŒ‡é’ˆï¼š`isa`å’Œ`superclass`ã€‚é‚£ä¹ˆåˆæ˜¯å¦‚ä½•ä¸²è”çš„ï¼Ÿ

æ¨ªå‘è”ç³»ï¼š`isa`çš„ä½œç”¨å°±æ˜¯ï¼Œå°†**æŸä¸€ä¸ªç±»çš„instanceå¯¹è±¡ã€classå¯¹è±¡ã€meta-classå¯¹è±¡å»ºç«‹äº†æ¨ªå‘è”ç³»**ï¼Œä¸ºæŸ¥æ‰¾å¯¹è±¡å­˜å‚¨å„ç±»ä¿¡æ¯æä¾›æŒ‡å¼•ã€‚

çºµå‘è”ç³»ï¼š`superclass`åˆ™æ˜¯é¢å‘å¯¹è±¡è¯­è¨€ä¸­æœ€ä¸ºé‡è¦çš„ç‰¹æ€§â€”â€”ç»§æ‰¿çš„ä½“ç°ï¼Œå®ƒä½“ç°çš„æ˜¯**ç±»ä¸ç±»ä¹‹é—´çš„è”ç³»**ï¼Œå³ä¸ºç±»å›¾ä¸­å»ºç«‹äº†**çºµå‘è”ç³»**ã€‚

**è¯·æ³¨æ„åŒºåˆ†**ï¼šä¸€ä¸ªç±»å„ç§å¯¹è±¡ä¹‹é—´çš„è”ç³»ï¼Œä»¥åŠä¸åŒç±»ä¹‹é—´çš„è”ç³»ï¼

## 3.1 isa

### 3.1.1 isaæŒ‡é’ˆ

![image-20181123102401283](https://raw.githubusercontent.com/awanglilong/blog/main/uPic/2018-11-23-022401.png)



### 3.1.2 **ISA_MASK**

![image-20181123102411439](https://raw.githubusercontent.com/awanglilong/blog/main/uPic/2018-11-23-022412.png)



## 3.2 superclass

### 3.2.1 classå¯¹è±¡

![image-20181123100901305](https://raw.githubusercontent.com/awanglilong/blog/main/uPic/2018-11-23-022054.png)

### 3.2.2 meta-classå¯¹è±¡

![image-20181123102215644](https://raw.githubusercontent.com/awanglilong/blog/main/uPic/2018-11-23-022215.png)

## 3.3 ç±»å›¾ä½“ç³»

### 3.3.1 è”ç³»

- `isa`æŒ‡å‘
  - instanceçš„`isa`æŒ‡å‘class
  - classçš„`isa`æŒ‡å‘meta-class
  - meta-classçš„`isa`æŒ‡å‘åŸºç±»çš„meta-class
- superclassæŒ‡å‘
  - classçš„`superclass`æŒ‡å‘çˆ¶ç±»çš„class
    å¦‚æœæ²¡æœ‰çˆ¶ç±»ï¼Œ`superclass`æŒ‡é’ˆä¸ºnil
  - meta-classçš„`superclass`æŒ‡å‘çˆ¶ç±»çš„meta-class
    **åŸºç±»çš„meta-classçš„`superclass`æŒ‡å‘åŸºç±»çš„class**

### 3.3.2 æ–¹æ³•è°ƒç”¨

1. instanceè°ƒç”¨å¯¹è±¡æ–¹æ³•çš„è½¨è¿¹
   `isa`æ‰¾åˆ°classï¼Œæ–¹æ³•ä¸å­˜åœ¨ï¼Œå°±é€šè¿‡`superclass`æ‰¾çˆ¶ç±»
2. classè°ƒç”¨ç±»æ–¹æ³•çš„è½¨è¿¹
   `isa`æ‰¾meta-classï¼Œæ–¹æ³•ä¸å­˜åœ¨ï¼Œå°±é€šè¿‡`superclass`æ‰¾çˆ¶ç±»

### 3.3.3 åˆ†æ

é’ˆå¯¹æƒ…å†µ1å’Œ2ï¼Œå¤§éƒ¨åˆ†æˆ‘ä»¬éƒ½èƒ½ç†è§£ï¼Œä½†æœ‰ä¸€ç§æƒ…å†µã€‚æ˜¯æœ‰å·®åˆ«çš„ã€‚

åœ¨BFStudentå’ŒBFPersonä¸­å‡æœªå®ç°å¯¹åº”çš„å¯¹è±¡æ–¹æ³•ï¼ˆç±»æ–¹æ³•ï¼‰æ—¶ï¼Œéƒ½ä¼šå»NSObjectä¸­å¯»æ‰¾ã€‚

- å¯¹è±¡æ–¹æ³•ï¼šNSObjectå¯»æ‰¾å¯¹åº”çš„å¯¹è±¡æ–¹æ³•ï¼Œæœªæ‰¾åˆ°å¯¹è±¡æ–¹æ³•ï¼Œå´©æºƒï¼Œå‚è€ƒä¸‹é¢çš„è“è‰²ç®­å¤´ã€‚
- ç±»æ–¹æ³•ï¼šNSObjectå…ˆå¯»æ‰¾å¯¹åº”çš„ç±»æ–¹æ³•ï¼Œæœªæ‰¾åˆ°ç±»æ–¹æ³•ï¼Œç„¶åç»§ç»­å¯»æ‰¾å¯¹åº”çš„å®ä¾‹æ–¹æ³•ï¼Œè‹¥ä¸¤è€…æœªæ‰¾åˆ°ï¼Œæ‰ä¼šå´©æºƒï¼Œè§ä¸‹é¢çš„é»„è‰²ç®­å¤´ã€‚

![image-20181210131420601](https://raw.githubusercontent.com/awanglilong/blog/main/uPic/20190523175701.png)

